<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sri Computers ‚Äî Complete Management (Final Fixed)</title>
<style>
:root{--blue:#0b63d6;--accent:#ff9800;--success:#4caf50;--danger:#f44336;--muted:#666}
*{box-sizing:border-box;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif}
body{margin:0;background:#f4f7fb;color:#162029}
.container{max-width:1200px;margin:18px auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(15,30,50,0.06)}
.header{display:flex;justify-content:space-between;align-items:center}
.title{color:var(--blue);font-size:20px;font-weight:700}
.subtitle{color:var(--muted);font-size:13px}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px;border-bottom:1px solid #e8f4ff;padding-bottom:10px}
.tab{padding:8px 12px;border-radius:8px;border:1px solid transparent;background:#f6fbff;color:var(--blue);cursor:pointer}
.tab.active{background:var(--blue);color:#fff}
.page{display:none;padding-top:16px}
.page.active{display:block}
.card{background:#fff;border-radius:8px;padding:14px;border:1px solid #f1f6fb;margin-bottom:14px}
label{display:block;margin-top:10px;font-weight:600}
input,textarea,select,button{font-family:inherit}
input,textarea,select{width:100%;padding:8px;border:1px solid #e6f3ff;border-radius:8px;margin-top:6px}
textarea{resize:vertical}
button{padding:8px 12px;border-radius:8px;border:none;background:var(--blue);color:#fff;cursor:pointer}
button.secondary{background:#eef8ff;color:var(--blue);border:1px solid #dff0ff}
.button-inline{display:inline-block;margin-right:8px}
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #f1f6fb}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #f6fbff;text-align:left}
th{background:var(--blue);color:#fff}
.small{font-size:13px;color:var(--muted)}
.inv-row{display:grid;grid-template-columns:120px 1.5fr 80px 100px 100px 100px;gap:8px;align-items:end;margin-top:8px}
.svc-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;align-items:end;margin-top:8px}
.autocomplete{position:relative}
.autocomplete-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #e6f3ff;max-height:240px;overflow:auto;z-index:40}
.autocomplete-item{padding:8px;border-bottom:1px solid #f2f7ff;cursor:pointer}
.autocomplete-item:hover{background:#f6fbff}
.print-area{display:none}
.pvc-card{width:86mm;height:54mm;border-radius:6px;border:1px solid #e6f3ff;background:#fff;overflow:hidden}
.low-stock{background:#fff4f4;border-left:4px solid var(--danger);padding:8px;border-radius:6px}
.btn-red{background:var(--danger);color:#fff;border-radius:6px;padding:6px 8px;border:none;cursor:pointer}
@media print{body *{visibility:hidden} .print-area, .print-area *{visibility:visible} .print-area{position:fixed;left:0;top:0;width:100%}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">üñ•Ô∏è SRI COMPUTERS ‚Äî MANAGEMENT</div>
      <div class="subtitle">Complete offline system ‚Äî customers, products, services, invoices, PVC cards, backup</div>
    </div>
    <div>
      <button class="secondary button-inline" id="btnBackupNow">Backup Now</button>
      <button class="secondary button-inline" id="btnAutoBackupToggle">Auto Backup: Off</button>
      <button onclick="openLogin()" class="button-inline secondary">Login</button>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Main tabs">
    <button class="tab active" data-tab="dashboard" onclick="switchTab(event)">Dashboard</button>
    <button class="tab" data-tab="customers" onclick="switchTab(event)">Customers</button>
    <button class="tab" data-tab="products" onclick="switchTab(event)">Products</button>
    <button class="tab" data-tab="services" onclick="switchTab(event)">Service</button>
    <button class="tab" data-tab="invoices" onclick="switchTab(event)">Invoices</button>
    <button class="tab" data-tab="pvccard" onclick="switchTab(event)">PVC Card</button>
    <button class="tab" data-tab="followups" onclick="switchTab(event)">Follow-ups</button>
    <button class="tab" data-tab="export" onclick="switchTab(event)">Export/Backup</button>
  </div>

  <!-- DASHBOARD -->
  <section id="dashboard" class="page active">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:6px 0">Quick Overview</h3>
          <div class="small" id="quickStats"></div>
        </div>
        <div id="lowStockArea"></div>
      </div>
    </div>
    <div id="statCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px"></div>
  </section>

  <!-- CUSTOMERS -->
  <section id="customers" class="page">
    <div class="card">
      <h3>Customer Management</h3>
      <input type="hidden" id="editCustomerId">
      <label>Customer Code</label>
      <input id="custCode" readonly>
      <label>Name *</label>
      <input id="custName">
      <label>Phone *</label>
      <input id="custPhone">
      <label>Address</label>
      <textarea id="custAddr" rows="2"></textarea>
      <label>GSTIN</label>
      <input id="custGst">
      <label>Email</label>
      <input id="custMail" type="email">
      <div style="margin-top:10px">
        <button onclick="saveCustomer()">Save Customer</button>
        <button class="secondary" id="cancelCustBtn" onclick="cancelCustomerEdit()" style="display:none">Cancel</button>
      </div>
    </div>

    <div class="card">
      <h4>Customer List</h4>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="searchCustName" placeholder="Search name...">
        <input id="searchCustPhone" placeholder="Search phone...">
        <button class="secondary" onclick="searchCustomers()">Search</button>
        <button class="secondary" onclick="clearCustomerSearch()">Clear</button>
      </div>
      <div id="customerList" class="table-wrap"></div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section id="products" class="page">
    <div class="card">
      <h3>Products</h3>
      <div style="background:#fff8e1;padding:10px;border-radius:8px;margin-bottom:10px">
        <strong>Import CSV</strong>
        <div class="small">Columns: Category,ItemNo,Description,SellingPrice,StockQty,WarrantyMonths</div>
        <input id="productFile" type="file" accept=".csv" style="margin-top:8px">
        <div style="margin-top:8px">
          <button class="secondary" onclick="importProducts()">Import</button>
          <button class="secondary" onclick="downloadProductTemplate()">Download Template</button>
        </div>
      </div>

      <label>Category</label>
      <input id="prodCategory">
      <label>Item No (leave blank to auto-generate)</label>
      <input id="prodItemNo">
      <label>Description *</label>
      <input id="prodDesc">
      <label>Price *</label>
      <input id="prodPrice" type="number" step="0.01">
      <label>Stock Qty</label>
      <input id="prodStock" type="number" value="0">
      <label>Warranty (months)</label>
      <input id="prodWarranty" type="number" value="0">
      <div style="margin-top:10px">
        <button onclick="saveProduct()">Save Product</button>
      </div>
    </div>

    <div class="card">
      <h4>Product List</h4>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="searchProdCode" placeholder="Item no...">
        <input id="searchProdDesc" placeholder="Description...">
        <button class="secondary" onclick="searchProducts()">Search</button>
        <button class="secondary" onclick="clearProductSearch()">Clear</button>
      </div>
      <div id="productList" class="table-wrap"></div>
    </div>
  </section>

  <!-- SERVICES -->
  <section id="services" class="page">
    <div class="card">
      <h3>Service Sheet</h3>
      <input type="hidden" id="editServiceId">
      <label>Customer Code</label>
      <div style="display:flex;gap:8px"><input id="svcCustCode"><button class="secondary" onclick="loadServiceCustomer()">Load</button></div>
      <label>Customer Name</label>
      <input id="svcCustName" readonly>
      <label>Service No</label>
      <input id="svcNo" readonly>
      <h4 style="margin-top:12px">Service Items (you requested)</h4>
      <div id="serviceRows"></div>
      <div style="margin-top:8px">
        <button class="secondary" onclick="addServiceRow()">‚ûï Add Row</button>
        <button class="button-inline" onclick="saveService()">Save Service</button>
        <button class="secondary" onclick="clearServiceForm()">Clear</button>
      </div>
    </div>

    <div class="card">
      <h4>Service Records</h4>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="searchSvc" placeholder="Search service no / customer...">
        <button class="secondary" onclick="searchServices()">Search</button>
        <button class="secondary" onclick="clearServiceSearch()">Clear</button>
      </div>
      <div id="serviceList" class="table-wrap"></div>
    </div>
  </section>

  <!-- INVOICES -->
  <section id="invoices" class="page">
    <div class="card no-print">
      <h3>Create Invoice</h3>
      <input type="hidden" id="editingInvoiceId">
      <label>Invoice No</label>
      <input id="invNo" readonly>
      <label>Invoice Date</label>
      <input id="invDate" type="date">
      <label>Service Sheet No (optional)</label>
      <div style="display:flex;gap:8px"><input id="invServiceNo"><button class="secondary" onclick="loadServiceIntoInvoice()">Load</button></div>
      <label>Customer Code</label>
      <div style="display:flex;gap:8px"><input id="invCustCode"><button class="secondary" onclick="loadInvoiceCustomer()">Load</button></div>
      <label>Customer Name</label>
      <input id="invCustName" readonly>

      <h4 style="margin-top:12px">Invoice Items</h4>
      <div id="invoiceItems"></div>
      <div style="margin-top:8px">
        <button class="secondary" onclick="addInvoiceRow()">‚ûï Add Item</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <div>
          <label>Subtotal</label>
          <input id="invSubtotal" readonly>
        </div>
        <div>
          <label>Total Amount</label>
          <input id="invTotal" readonly>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
        <div>
          <label>Discount (%)</label>
          <input id="invDiscount" type="number" value="0" oninput="calculateInvoiceTotal()">
        </div>
        <div>
          <label>Tax/GST (%)</label>
          <input id="invTax" type="number" value="0" oninput="calculateInvoiceTotal()">
        </div>
      </div>

      <div style="margin-top:10px;background:#eef7ff;padding:10px;border-radius:8px">
        <label>Payment Status</label>
        <select id="invPayStatus" onchange="togglePartialPayment()"><option>Paid</option><option>Pending</option><option>Partial</option></select>
        <div id="partialPaymentDiv" style="display:none;margin-top:8px">
          <label>Amount Paid</label>
          <input id="invAmountPaid" type="number" oninput="calculateBalance()">
          <label>Balance Due</label>
          <input id="invBalance" readonly>
        </div>
        <label>Payment Mode</label>
        <select id="invPayMode"><option>Cash</option><option>UPI</option><option>Card</option><option>Net Banking</option><option>Cheque</option></select>
        <label>Payment Reference</label>
        <input id="invPayRef" placeholder="UTR/Txn ID">
      </div>

      <label style="margin-top:8px">Notes</label>
      <textarea id="invNotes" rows="2"></textarea>

      <div style="margin-top:10px">
        <button onclick="saveInvoice()">Save Invoice</button>
        <button class="secondary" onclick="printCurrentInvoice()">Print Invoice</button>
      </div>
    </div>

    <div class="card">
      <h4>Saved Invoices</h4>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="searchInv" placeholder="Invoice no / customer...">
        <button class="secondary" onclick="searchInvoices()">Search</button>
        <button class="secondary" onclick="clearInvoiceSearch()">Clear</button>
      </div>
      <div id="invoiceList" class="table-wrap"></div>
    </div>

    <div id="printArea" class="print-area"></div>
  </section>

  <!-- PVC CARD -->
  <section id="pvccard" class="page">
    <div class="card">
      <h4>PVC Card</h4>
      <label>Customer Code</label>
      <div style="display:flex;gap:8px"><input id="pvcCustCode"><button class="secondary" onclick="loadPVCCustomer()">Load</button></div>
      <label>Customer Name</label>
      <input id="pvcCustName" readonly>
      <label>Phone</label>
      <input id="pvcCustPhone" readonly>
      <label>Model No</label>
      <input id="pvcModel">
      <label>Start Date</label>
      <input id="pvcStartDate" type="date">
      <label>End Date</label>
      <input id="pvcEndDate" type="date">
      <div style="margin-top:10px">
        <button class="secondary" onclick="generatePVCCard()">Generate Preview</button>
        <button onclick="printPVCCard()">Print Card</button>
      </div>
    </div>
    <div id="pvcPreviewHolder"></div>
  </section>

  <!-- FOLLOWUPS -->
  <section id="followups" class="page">
    <div class="card">
      <h4>Follow-up</h4>
      <label>Date</label>
      <input id="fuDate" type="date">
      <label>Name</label>
      <input id="fuName">
      <label>Phone</label>
      <input id="fuPhone">
      <label>Requirement</label>
      <textarea id="fuReq"></textarea>
      <label>Status</label>
      <select id="fuStatus"><option>Pending</option><option>Completed</option><option>Follow-up Required</option></select>
      <div style="margin-top:8px"><button onclick="saveFollowup()">Save</button></div>
    </div>
    <div class="card"><h4>Follow-ups</h4><div id="followupList"></div></div>
  </section>

  <!-- EXPORT / BACKUP -->
  <section id="export" class="page">
    <div class="card">
      <h4>Export & Backup</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="secondary" onclick="exportCustomers()">Export Customers</button>
        <button class="secondary" onclick="exportProducts()">Export Products</button>
        <button class="secondary" onclick="exportServices()">Export Services</button>
        <button class="secondary" onclick="exportInvoices()">Export Invoices</button>
        <button class="secondary" onclick="exportFollowups()">Export Follow-ups</button>
        <button onclick="backupAll()">Download Backup (JSON)</button>
        <button class="secondary" id="setAutoBackup">Set Auto Backup</button>
        <input id="restoreFile" type="file" accept=".json" style="display:none" onchange="restoreAll(event)">
        <button class="secondary" onclick="document.getElementById('restoreFile').click()">Restore from Backup</button>
      </div>
      <div style="margin-top:8px" class="small">Auto-backup will create a downloadable file in your browser periodically. It does not upload to cloud.</div>
    </div>
  </section>

</div>

<!-- LOGIN MODAL -->
<div id="loginModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center">
  <div style="background:#fff;padding:16px;border-radius:10px;max-width:360px;margin:60px auto">
    <h4>Login</h4>
    <label>Username</label><input id="loginUser">
    <label>Password</label><input id="loginPass" type="password">
    <div style="margin-top:8px;text-align:right"><button onclick="performLogin()">Login</button> <button class="secondary" onclick="closeLogin()">Close</button></div>
    <div class="small" style="margin-top:8px">Default user: admin / password (stored locally)</div>
  </div>
</div>

<script>
// ---------------- Data & Storage ----------------
const STORAGE_KEY='sri_computers_final_v2';
let customers=[], products=[], services=[], invoices=[], followups=[];
let autoBackupIntervalId=null;

function loadAllData(){ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ try{ const d=JSON.parse(raw); customers=d.customers||[]; products=d.products||[]; services=d.services||[]; invoices=d.invoices||[]; followups=d.followups||[]; }catch(e){console.warn('parse error',e);} } else { // seed admin user if not present
 if(!localStorage.getItem('sc_users')) localStorage.setItem('sc_users', JSON.stringify([{username:'admin',password:'password'}])); }
}
function saveAllData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({customers,products,services,invoices,followups})); renderAll(); }

// ---------------- Utility ----------------
function switchTab(e){ const id=(e.target||e).getAttribute('data-tab'); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab').forEach(t=>{ if(t.getAttribute('data-tab')===id) t.classList.add('active'); }); document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); const el=document.getElementById(id); if(el) el.classList.add('active'); }
function downloadFile(content,filename,type='text/plain'){ const blob=new Blob([content],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }
function formatCurrency(v){ return '‚Çπ'+(parseFloat(v)||0).toFixed(2); }

// ---------------- Codes ----------------
function generateCustomerCode(){ return 'C'+String(customers.length+1).padStart(4,'0'); }
function generateProductCode(){ return 'ITM'+String(products.length+1).padStart(3,'0'); }
function generateServiceCode(){ return 'SR'+String(services.length+1).padStart(4,'0'); }
function generateInvoiceCode(){ return 'INV'+String(invoices.length+1).padStart(4,'0'); }

// ---------------- Customers ----------------
function saveCustomer(){ const id=document.getElementById('editCustomerId').value; const name=document.getElementById('custName').value.trim(); const phone=document.getElementById('custPhone').value.trim(); if(!name||!phone){ alert('Name and Phone required'); return; } const addr=document.getElementById('custAddr').value.trim(); const gst=document.getElementById('custGst').value.trim(); const mail=document.getElementById('custMail').value.trim(); if(id){ const idx=customers.findIndex(c=>c.id==id); if(idx>-1){ customers[idx]={...customers[idx],name,phone,addr,gst,mail}; alert('Customer updated'); } } else { const code=generateCustomerCode(); customers.push({id:Date.now(),code,name,phone,addr,gst,mail}); alert('Customer added'); }
 saveAllData(); clearCustomerForm(); }
function editCustomer(id){ const c=customers.find(x=>x.id==id); if(!c) return; document.getElementById('editCustomerId').value=c.id; document.getElementById('custCode').value=c.code; document.getElementById('custName').value=c.name; document.getElementById('custPhone').value=c.phone; document.getElementById('custAddr').value=c.addr||''; document.getElementById('custGst').value=c.gst||''; document.getElementById('custMail').value=c.mail||''; document.getElementById('cancelCustBtn').style.display='inline-block'; document.querySelector('[data-tab="customers"]').click(); }
function deleteCustomer(id){ if(!confirm('Delete this customer?')) return; customers=customers.filter(c=>c.id!=id); saveAllData(); }
function clearCustomerForm(){ document.getElementById('editCustomerId').value=''; document.getElementById('custCode').value=generateCustomerCode(); document.getElementById('custName').value=''; document.getElementById('custPhone').value=''; document.getElementById('custAddr').value=''; document.getElementById('custGst').value=''; document.getElementById('custMail').value=''; document.getElementById('cancelCustBtn').style.display='none'; }
function displayCustomers(list=customers){ const div=document.getElementById('customerList'); if(!list.length) return div.innerHTML='<p class="small">No customers</p>'; let html='<table><thead><tr><th>Code</th><th>Name</th><th>Phone</th><th>Actions</th></tr></thead><tbody>'; list.forEach(c=>{ html+=`<tr><td>${c.code}</td><td>${c.name}</td><td>${c.phone}</td><td><button class="secondary" onclick="editCustomer(${c.id})">Edit</button> <button onclick="deleteCustomer(${c.id})" class="button-inline btn-red">Delete</button> <button class="button-inline" onclick="useCustomerInInvoice('${c.code}')">Use in Invoice</button></td></tr>`; }); html+='</tbody></table>'; div.innerHTML=html; }
function searchCustomers(){ const name=document.getElementById('searchCustName').value.toLowerCase(); const phone=document.getElementById('searchCustPhone').value.toLowerCase(); const filtered=customers.filter(c=>c.name.toLowerCase().includes(name) && c.phone.toLowerCase().includes(phone)); displayCustomers(filtered); }
function clearCustomerSearch(){ document.getElementById('searchCustName').value=''; document.getElementById('searchCustPhone').value=''; displayCustomers(); }
function useCustomerInInvoice(code){ document.getElementById('invCustCode').value=code; document.querySelector('[data-tab="invoices"]').click(); setTimeout(()=>loadInvoiceCustomer(),150); }

// ---------------- Products ----------------
function saveProduct(){ let itemNo=document.getElementById('prodItemNo').value.trim(); const category=document.getElementById('prodCategory').value.trim(); const desc=document.getElementById('prodDesc').value.trim(); const price=parseFloat(document.getElementById('prodPrice').value)||0; const stock=parseInt(document.getElementById('prodStock').value)||0; const warranty=parseInt(document.getElementById('prodWarranty').value)||0; if(!desc||!price){ alert('Description and Price required'); return; } if(!itemNo){ itemNo=generateProductCode(); while(products.find(p=>p.itemNo===itemNo)) itemNo='ITM'+String(products.length+1).padStart(3,'0'); } if(products.find(p=>p.itemNo===itemNo)){ alert('Item number already exists'); return; } products.push({id:Date.now(),category,itemNo,desc,price,stock,warranty}); saveAllData(); alert('Product saved'); document.getElementById('prodCategory').value=''; document.getElementById('prodItemNo').value=''; document.getElementById('prodDesc').value=''; document.getElementById('prodPrice').value=''; document.getElementById('prodStock').value=0; document.getElementById('prodWarranty').value=0; }
function displayProducts(list=products){ const div=document.getElementById('productList'); if(!list.length) return div.innerHTML='<p class="small">No products</p>'; let html='<table><thead><tr><th>Item No</th><th>Description</th><th>Price</th><th>Stock</th><th>Warranty(m)</th><th>Actions</th></tr></thead><tbody>'; list.forEach(p=>{ html+=`<tr><td>${p.itemNo}</td><td>${p.desc}</td><td>${formatCurrency(p.price)}</td><td>${p.stock}</td><td>${p.warranty}</td><td><button class="secondary" onclick="editProduct(${p.id})">Edit</button> <button class="button-inline btn-red" onclick="deleteProduct(${p.id})">Delete</button></td></tr>`; }); html+='</tbody></table>'; div.innerHTML=html; }
function editProduct(id){ const p=products.find(x=>x.id==id); if(!p) return; document.getElementById('prodCategory').value=p.category||''; document.getElementById('prodItemNo').value=p.itemNo; document.getElementById('prodDesc').value=p.desc; document.getElementById('prodPrice').value=p.price; document.getElementById('prodStock').value=p.stock; document.getElementById('prodWarranty').value=p.warranty; // delete old and save new on save
 products=products.filter(x=>x.id!=id); }
function deleteProduct(id){ if(!confirm('Delete this product?')) return; products=products.filter(p=>p.id!=id); saveAllData(); }
function searchProducts(){ const code=document.getElementById('searchProdCode').value.toLowerCase(); const desc=document.getElementById('searchProdDesc').value.toLowerCase(); const filtered=products.filter(p=>p.itemNo.toLowerCase().includes(code) && p.desc.toLowerCase().includes(desc)); displayProducts(filtered); }
function clearProductSearch(){ document.getElementById('searchProdCode').value=''; document.getElementById('searchProdDesc').value=''; displayProducts(); }
function downloadProductTemplate(){ const csv='Category,ItemNo,Description,SellingPrice,StockQty,WarrantyMonths\nLaptop,ITM001,Dell Laptop,45000,5,12\nMouse,ITM002,Logitech Mouse,500,20,6\n'; downloadFile(csv,'product_template.csv','text/csv'); }
function importProducts(){ const f=document.getElementById('productFile').files[0]; if(!f){ alert('Select CSV'); return; } const reader=new FileReader(); reader.onload=(e)=>{ const lines=e.target.result.split(/\r?\n/); let count=0; for(let i=1;i<lines.length;i++){ const l=lines[i].trim(); if(!l) continue; const cols=l.split(','); if(cols.length<6) continue; const itemNo=cols[1].trim(); if(products.find(p=>p.itemNo===itemNo)) continue; products.push({id:Date.now()+i,category:cols[0].trim(),itemNo,desc:cols[2].trim(),price:parseFloat(cols[3])||0,stock:parseInt(cols[4])||0,warranty:parseInt(cols[5])||0}); count++; } saveAllData(); alert('Imported '+count+' products'); document.getElementById('productFile').value=''; }; reader.readAsText(f); }

// ---------------- Services ----------------
function loadServiceCustomer(){ const code=document.getElementById('svcCustCode').value.trim(); const c=customers.find(x=>x.code===code); if(!c){ alert('Customer not found'); return; } document.getElementById('svcCustName').value=c.name; }
function createServiceRow(data={}){ const div=document.createElement('div'); div.className='svc-row'; div.innerHTML=`<input type="date" class="svcDate" value="${data.date||''}"> <input class="svcModel" placeholder="Model" value="${data.model||''}"> <input class="svcComplaint" placeholder="Complaint" value="${data.complaint||''}"> <input class="svcSpare" placeholder="Spare Parts" value="${data.spare||''}"> <input class="svcAmount" placeholder="Amount" value="${data.amount||''}"> <input class="svcRemarks" placeholder="Remarks" value="${data.remarks||''}"> <input class="svcTechnician" placeholder="Technician" value="${data.technician||''}"> <select class="svcStatus"><option ${data.status==='Pending'?'selected':''}>Pending</option><option ${data.status==='In Progress'?'selected':''}>In Progress</option><option ${data.status==='Completed'?'selected':''}>Completed</option></select> <input class="svcSerial" placeholder="Serial no" value="${data.serial||''}"> <button class="btn-red" onclick="this.parentElement.remove()">Remove</button>`; document.getElementById('serviceRows').appendChild(div); }
function addServiceRow(){ createServiceRow(); }
function clearServiceForm(){ document.getElementById('editServiceId').value=''; document.getElementById('svcCustCode').value=''; document.getElementById('svcCustName').value=''; document.getElementById('serviceRows').innerHTML=''; document.getElementById('svcNo').value=generateServiceCode(); }
function saveService(){ const editId=document.getElementById('editServiceId').value; const custCode=document.getElementById('svcCustCode').value.trim(); const custName=document.getElementById('svcCustName').value.trim(); if(!custCode||!custName){ alert('Load customer first'); return; } const rows=[]; document.querySelectorAll('#serviceRows .svc-row').forEach(r=>{ rows.push({ date:r.querySelector('.svcDate').value, model:r.querySelector('.svcModel').value, complaint:r.querySelector('.svcComplaint').value, spare:r.querySelector('.svcSpare').value, amount:r.querySelector('.svcAmount').value, remarks:r.querySelector('.svcRemarks').value, technician:r.querySelector('.svcTechnician').value, status:r.querySelector('.svcStatus').value, serial:r.querySelector('.svcSerial').value }); }); if(!rows.length){ alert('Add at least one row'); return; } if(editId){ const idx=services.findIndex(s=>s.id==editId); if(idx>-1){ services[idx].rows=rows; services[idx].custCode=custCode; services[idx].custName=custName; services[idx].date=new Date().toISOString().split('T')[0]; alert('Service updated'); } } else { const svcNo=generateServiceCode(); services.push({id:Date.now(),svc:svcNo,custCode,custName,date:new Date().toISOString().split('T')[0],rows}); alert('Service saved'); } saveAllData(); clearServiceForm(); }
function displayServices(list=services){ const div=document.getElementById('serviceList'); if(!list.length) return div.innerHTML='<p class="small">No services</p>'; let html='<table><thead><tr><th>Service No</th><th>Customer</th><th>Date</th><th>Items</th><th>Actions</th></tr></thead><tbody>'; list.forEach(s=>{ html+=`<tr><td>${s.svc}</td><td>${s.custName}</td><td>${s.date}</td><td>${s.rows.length}</td><td><button class="secondary" onclick="editService(${s.id})">Edit</button> <button onclick="linkServiceToInvoice('${s.svc}')" class="button-inline">Use</button> <button class="secondary" onclick="printService(${s.id})">Print</button> <button class="btn-red" onclick="deleteService(${s.id})">Delete</button></td></tr>`; }); html+='</tbody></table>'; div.innerHTML=html; }
function editService(id){ const s=services.find(x=>x.id==id); if(!s) return; document.getElementById('editServiceId').value=s.id; document.getElementById('svcCustCode').value=s.custCode; document.getElementById('svcCustName').value=s.custName; document.getElementById('svcNo').value=s.svc; document.getElementById('serviceRows').innerHTML=''; s.rows.forEach(r=>createServiceRow(r)); document.querySelector('[data-tab="services"]').click(); }
function deleteService(id){ if(!confirm('Delete service record?')) return; services=services.filter(s=>s.id!=id); saveAllData(); }
function printService(id){ const s=services.find(x=>x.id==id); if(!s) return; let html=`<div style="padding:18px;font-family:inherit"><h2>Service Job Card - ${s.svc}</h2><p><strong>Customer:</strong> ${s.custName} (${s.custCode})</p><p><strong>Date:</strong> ${s.date}</p><table style="width:100%;border-collapse:collapse"><thead><tr><th>#</th><th>Date</th><th>Model</th><th>Complaint</th><th>Spare</th><th>Amount</th><th>Technician</th><th>Serial</th><th>Status</th></tr></thead><tbody>`; s.rows.forEach((r,i)=>{ html+=`<tr><td>${i+1}</td><td>${r.date||''}</td><td>${r.model||''}</td><td>${r.complaint||''}</td><td>${r.spare||''}</td><td>${r.amount||''}</td><td>${r.technician||''}</td><td>${r.serial||''}</td><td>${r.status||''}</td></tr>`; }); html+='</tbody></table><p style="text-align:right;margin-top:12px">Authorized Signature: ____________________</p></div>'; const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.print(); }

// ---------------- Invoices ----------------
function addInvoiceRow(item={}){ const div=document.createElement('div'); div.className='inv-row'; div.innerHTML=`<div class="autocomplete"><input class="prodCode" placeholder="Code or search" oninput="showProductSuggestions(this)" value="${item.code||''}"><div class="autocomplete-list" style="display:none"></div></div><input class="prodDesc" placeholder="Description" value="${item.desc||''}"><input class="prodQty" type="number" value="${item.qty||1}" oninput="calculateRowTotal(this)"><input class="prodRate" type="number" value="${item.rate||''}" oninput="calculateRowTotal(this)"><input class="prodAmt" readonly value="${item.amt||''}"><input class="prodWarranty" readonly value="${item.warrantyExpiry||''}"><button class="btn-red" onclick="this.parentElement.remove();calculateInvoiceTotal()">Remove</button>`; document.getElementById('invoiceItems').appendChild(div); if(item.code) calculateRowTotal(div.querySelector('.prodQty')); }
function showProductSuggestions(input){ const term=input.value.toLowerCase(); const list=input.nextElementSibling; if(!term){ list.style.display='none'; return; } const matches=products.filter(p=>p.itemNo.toLowerCase().includes(term) || p.desc.toLowerCase().includes(term)).slice(0,12); if(!matches.length){ list.style.display='none'; return; } list.innerHTML=''; matches.forEach(m=>{ const el=document.createElement('div'); el.className='autocomplete-item'; el.innerText=`${m.itemNo} - ${m.desc} (‚Çπ${m.price})`; el.onclick=()=>{ selectProductInRow(m,input); }; list.appendChild(el); }); list.style.display='block'; }
function selectProductInRow(product,inputElem){ const row=inputElem.closest('.inv-row'); row.querySelector('.prodCode').value=product.itemNo; row.querySelector('.prodDesc').value=product.desc; row.querySelector('.prodRate').value=product.price; const invDate=document.getElementById('invDate').value||new Date().toISOString().split('T')[0]; if(product.warranty && product.warranty>0){ const d=new Date(invDate); d.setMonth(d.getMonth()+product.warranty); row.querySelector('.prodWarranty').value=d.toISOString().split('T')[0]; } calculateRowTotal(row.querySelector('.prodQty')); inputElem.nextElementSibling.style.display='none'; }
function calculateRowTotal(input){ const row=input.closest('.inv-row'); const qty=parseFloat(row.querySelector('.prodQty').value)||0; const rate=parseFloat(row.querySelector('.prodRate').value)||0; row.querySelector('.prodAmt').value=(qty*rate).toFixed(2); calculateInvoiceTotal(); }
function calculateInvoiceTotal(){ let subtotal=0; document.querySelectorAll('#invoiceItems .inv-row').forEach(r=>{ subtotal+=parseFloat(r.querySelector('.prodAmt').value)||0; }); const disc=parseFloat(document.getElementById('invDiscount').value)||0; const tax=parseFloat(document.getElementById('invTax').value)||0; const afterDisc=subtotal - (subtotal*disc/100); const total=afterDisc + (afterDisc*tax/100); document.getElementById('invSubtotal').value=subtotal.toFixed(2); document.getElementById('invTotal').value=total.toFixed(2); if(document.getElementById('invPayStatus').value==='Partial') calculateBalance(); }
function togglePartialPayment(){ const div=document.getElementById('partialPaymentDiv'); div.style.display=document.getElementById('invPayStatus').value==='Partial'?'block':'none'; if(div.style.display==='block') calculateBalance(); }
function calculateBalance(){ const total=parseFloat(document.getElementById('invTotal').value)||0; const paid=parseFloat(document.getElementById('invAmountPaid').value)||0; document.getElementById('invBalance').value=(total-paid).toFixed(2); }
function loadInvoiceCustomer(){ const code=document.getElementById('invCustCode').value.trim(); const c=customers.find(x=>x.code===code); if(!c){ alert('Customer not found'); return; } document.getElementById('invCustName').value=c.name; }
function loadServiceIntoInvoice(){ const svcNo=document.getElementById('invServiceNo').value.trim(); if(!svcNo){ alert('Enter service no'); return; } const s=services.find(x=>x.svc===svcNo); if(!s){ alert('Service not found'); return; } // populate basic customer
 document.getElementById('invCustCode').value=s.custCode; setTimeout(()=>loadInvoiceCustomer(),120); // add service items as invoice rows
 document.getElementById('invoiceItems').innerHTML=''; s.rows.forEach(r=>{ addInvoiceRow({ code:'', desc:r.complaint||r.model||'', qty:1, rate:r.amount||0, amt:(parseFloat(r.amount)||0).toFixed(2), warrantyExpiry:'' }); }); calculateInvoiceTotal(); }
function saveInvoice(){ const editingId=document.getElementById('editingInvoiceId').value; const custCode=document.getElementById('invCustCode').value.trim(); const custName=document.getElementById('invCustName').value.trim(); if(!custCode||!custName){ alert('Load customer'); return; } const items=[]; document.querySelectorAll('#invoiceItems .inv-row').forEach(r=>{ items.push({ code:r.querySelector('.prodCode').value, desc:r.querySelector('.prodDesc').value, qty:r.querySelector('.prodQty').value, rate:r.querySelector('.prodRate').value, amt:r.querySelector('.prodAmt').value, warrantyExpiry:r.querySelector('.prodWarranty').value }); }); if(!items.length){ alert('Add items'); return; } const invNo=document.getElementById('invNo').value||generateInvoiceCode(); const invObj={ id: editingId ? parseInt(editingId) : Date.now(), invNo, date:document.getElementById('invDate').value||new Date().toISOString().split('T')[0], serviceNo:document.getElementById('invServiceNo').value||'', custCode, custName, items, subtotal:document.getElementById('invSubtotal').value||'0.00', discount:document.getElementById('invDiscount').value||'0', tax:document.getElementById('invTax').value||'0', total:document.getElementById('invTotal').value||'0.00', payStatus:document.getElementById('invPayStatus').value, amountPaid:document.getElementById('invAmountPaid').value||'0.00', balance:document.getElementById('invBalance').value||'0.00', payMode:document.getElementById('invPayMode').value, payRef:document.getElementById('invPayRef').value||'', notes:document.getElementById('invNotes').value||'' }; if(editingId){ // update existing
    const idx=invoices.findIndex(x=>x.id==invObj.id);
    if(idx>-1) invoices[idx]=invObj;
    alert('Invoice updated');
  } else {
    invoices.push(invObj);
    alert('Invoice saved');
  }
  saveAllData();
  // set invoice form to new invoice
  document.getElementById('editingInvoiceId').value='';
  document.getElementById('invNo').value=generateInvoiceCode();
  document.getElementById('invoiceItems').innerHTML='';
  document.getElementById('invSubtotal').value=''; document.getElementById('invDiscount').value='0'; document.getElementById('invTax').value='0'; document.getElementById('invTotal').value=''; document.getElementById('invAmountPaid').value=''; document.getElementById('invBalance').value=''; document.getElementById('invNotes').value=''; document.getElementById('invCustCode').value=''; document.getElementById('invCustName').value=''; document.querySelector('[data-tab="invoices"]').click(); }
function deleteInvoice(id){ if(!confirm('Delete invoice?')) return; invoices=invoices.filter(i=>i.id!=id); saveAllData(); }
function searchInvoices(){ const term=document.getElementById('searchInv').value.toLowerCase(); const filtered=invoices.filter(i=>i.invNo.toLowerCase().includes(term) || i.custName.toLowerCase().includes(term)); displayInvoices(filtered); }
function clearInvoiceSearch(){ document.getElementById('searchInv').value=''; displayInvoices(); }

// New displayInvoices function (fixed)
function displayInvoices(list = invoices){
  const div = document.getElementById('invoiceList');
  if(!list || !list.length){ div.innerHTML = '<p class="small">No invoices</p>'; return; }
  let html = `<table><thead><tr><th>Invoice No</th><th>Date</th><th>Customer</th><th>Total</th><th>Actions</th></tr></thead><tbody>`;
  list.forEach(i=>{
    html += `<tr>
      <td>${i.invNo}</td>
      <td>${i.date}</td>
      <td>${i.custName}</td>
      <td>${formatCurrency(i.total)}</td>
      <td>
        <button class="secondary" onclick="loadInvoice(${i.id})">Open</button>
        <button class="secondary" onclick="printSavedInvoice(${i.id})">Print</button>
        <button class="btn-red" onclick="deleteInvoice(${i.id})">Delete</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  div.innerHTML = html;
}

// load invoice for editing/viewing
function loadInvoice(id){
  const inv = invoices.find(x=>x.id==id);
  if(!inv) return alert('Invoice not found');
  document.getElementById('editingInvoiceId').value = inv.id;
  document.getElementById('invNo').value = inv.invNo;
  document.getElementById('invDate').value = inv.date;
  document.getElementById('invServiceNo').value = inv.serviceNo || '';
  document.getElementById('invCustCode').value = inv.custCode;
  document.getElementById('invCustName').value = inv.custName;
  document.getElementById('invoiceItems').innerHTML = '';
  inv.items.forEach(it=>{
    addInvoiceRow({ code: it.code, desc: it.desc, qty: it.qty, rate: it.rate, amt: it.amt, warrantyExpiry: it.warrantyExpiry });
  });
  document.getElementById('invSubtotal').value = inv.subtotal;
  document.getElementById('invDiscount').value = inv.discount;
  document.getElementById('invTax').value = inv.tax;
  document.getElementById('invTotal').value = inv.total;
  document.getElementById('invPayStatus').value = inv.payStatus;
  document.getElementById('invAmountPaid').value = inv.amountPaid;
  document.getElementById('invBalance').value = inv.balance;
  document.getElementById('invPayMode').value = inv.payMode;
  document.getElementById('invPayRef').value = inv.payRef;
  document.getElementById('invNotes').value = inv.notes;
  togglePartialPayment();
  calculateInvoiceTotal();
  document.querySelector('[data-tab="invoices"]').click();
}

// print functions for invoices
function printInvoice(inv){
  let html = `<div style="padding:18px;font-family:inherit">
    <h2>Invoice - ${inv.invNo}</h2>
    <p><strong>Date:</strong> ${inv.date}</p>
    <p><strong>Customer:</strong> ${inv.custName} (${inv.custCode})</p>
    <table style="width:100%;border-collapse:collapse"><thead><tr><th>#</th><th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead><tbody>`;
  inv.items.forEach((it,i)=>{
    html += `<tr><td>${i+1}</td><td>${it.desc||it.code||''}</td><td>${it.qty||''}</td><td>${formatCurrency(it.rate||0)}</td><td>${formatCurrency(it.amt||0)}</td></tr>`;
  });
  html += `</tbody></table>
    <p style="text-align:right"><strong>Subtotal:</strong> ${formatCurrency(inv.subtotal)}</p>
    <p style="text-align:right"><strong>Discount:</strong> ${inv.discount}%</p>
    <p style="text-align:right"><strong>Tax:</strong> ${inv.tax}%</p>
    <h3 style="text-align:right">Total: ${formatCurrency(inv.total)}</h3>
    <p style="text-align:right">Payment Status: ${inv.payStatus} ${inv.payMode?(' | Mode: '+inv.payMode):''}</p>
    <p style="text-align:right">Notes: ${inv.notes||''}</p>
    <p style="text-align:right;margin-top:24px">Authorized Signature: ____________________</p>
  </div>`;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.print();
}

function printSavedInvoice(id){
  const inv = invoices.find(x=>x.id==id);
  if(!inv) return alert('Invoice not found');
  printInvoice(inv);
}

function printCurrentInvoice(){
  // build a temporary invoice from form
  const items=[];
  document.querySelectorAll('#invoiceItems .inv-row').forEach(r=>{
    items.push({ desc:r.querySelector('.prodDesc').value, qty:r.querySelector('.prodQty').value, rate:r.querySelector('.prodRate').value, amt:r.querySelector('.prodAmt').value });
  });
  const inv = {
    invNo: document.getElementById('invNo').value || 'TEMP',
    date: document.getElementById('invDate').value || new Date().toISOString().split('T')[0],
    custName: document.getElementById('invCustName').value || '',
    custCode: document.getElementById('invCustCode').value || '',
    items,
    subtotal: document.getElementById('invSubtotal').value || '0.00',
    discount: document.getElementById('invDiscount').value || '0',
    tax: document.getElementById('invTax').value || '0',
    total: document.getElementById('invTotal').value || '0.00',
    payStatus: document.getElementById('invPayStatus').value || 'Pending',
    payMode: document.getElementById('invPayMode').value || ''
  };
  printInvoice(inv);
}

// ---------------- Followups ----------------
function saveFollowup(){ const d=document.getElementById('fuDate').value; const n=document.getElementById('fuName').value.trim(); const p=document.getElementById('fuPhone').value.trim(); const r=document.getElementById('fuReq').value.trim(); const s=document.getElementById('fuStatus').value; if(!n){ alert('Enter name'); return;} followups.push({id:Date.now(),date:d,name:n,phone:p,req:r,status:s}); saveAllData(); document.getElementById('fuDate').value=''; document.getElementById('fuName').value=''; document.getElementById('fuPhone').value=''; document.getElementById('fuReq').value=''; displayFollowups(); }
function displayFollowups(){ let h='<table><tr><th>Date</th><th>Name</th><th>Phone</th><th>Req</th><th>Status</th></tr>'; followups.forEach(f=>h+=`<tr><td>${f.date}</td><td>${f.name}</td><td>${f.phone}</td><td>${f.req}</td><td>${f.status}</td></tr>`); h+='</table>'; document.getElementById('followupList').innerHTML=h; }

// ---------------- Backup/Export ----------------
function exportCustomers(){ downloadFile(JSON.stringify(customers,null,2),'customers.json'); }
function exportProducts(){ downloadFile(JSON.stringify(products,null,2),'products.json'); }
function exportServices(){ downloadFile(JSON.stringify(services,null,2),'services.json'); }
function exportInvoices(){ downloadFile(JSON.stringify(invoices,null,2),'invoices.json'); }
function exportFollowups(){ downloadFile(JSON.stringify(followups,null,2),'followups.json'); }
function backupAll(){ downloadFile(JSON.stringify({customers,products,services,invoices,followups},null,2),'sri_backup.json'); }
function restoreAll(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ try{ const d=JSON.parse(ev.target.result); customers=d.customers||[]; products=d.products||[]; services=d.services||[]; invoices=d.invoices||[]; followups=d.followups||[]; saveAllData(); alert('Restored'); }catch(err){ alert('Invalid backup'); }}; r.readAsText(f); }

// ---------------- Login ----------------
function openLogin(){ document.getElementById('loginModal').style.display='flex'; }
function closeLogin(){ document.getElementById('loginModal').style.display='none'; }
function performLogin(){ const u=document.getElementById('loginUser').value; const p=document.getElementById('loginPass').value; const users=JSON.parse(localStorage.getItem('sc_users')||'[]'); if(users.find(x=>x.username===u&&x.password===p)){ alert('Login successful'); closeLogin(); } else alert('Invalid login'); }

// ---------------- Render Dashboard ----------------
function renderDashboard(){ document.getElementById('quickStats').innerHTML=`Customers: ${customers.length} | Products: ${products.length} | Services: ${services.length} | Invoices: ${invoices.length}`; let low=products.filter(p=>p.stock<=2); let h=''; low.forEach(p=>h+=`<div class="low-stock">Low Stock: ${p.itemNo} - ${p.desc} (${p.stock})</div>`); document.getElementById('lowStockArea').innerHTML=h; let cards=''; cards+=`<div class="card">Total Customers: ${customers.length}</div>`; cards+=`<div class="card">Total Products: ${products.length}</div>`; cards+=`<div class="card">Total Services: ${services.length}</div>`; cards+=`<div class="card">Total Invoices: ${invoices.length}</div>`; document.getElementById('statCards').innerHTML=cards; }

// ---------------- Init ----------------
function renderAll(){ displayCustomers(); displayProducts(); displayServices(); displayInvoices(); displayFollowups(); renderDashboard(); }
loadAllData(); clearCustomerForm(); clearServiceForm(); document.getElementById('invNo').value=generateInvoiceCode(); document.getElementById('invDate').value=new Date().toISOString().split('T')[0]; renderAll();

// Auto backup toggle simple implementation
document.getElementById('btnBackupNow').addEventListener('click', backupAll);
document.getElementById('btnAutoBackupToggle').addEventListener('click', ()=>{
  if(autoBackupIntervalId){ clearInterval(autoBackupIntervalId); autoBackupIntervalId=null; document.getElementById('btnAutoBackupToggle').innerText='Auto Backup: Off'; alert('Auto backup stopped'); }
  else { autoBackupIntervalId=setInterval(()=>backupAll(), 1000*60*30); document.getElementById('btnAutoBackupToggle').innerText='Auto Backup: On'; alert('Auto backup enabled (every 30 mins)'); }
});
</script>
</body>
</html>
